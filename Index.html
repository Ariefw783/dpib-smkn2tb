<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PEMINJAMAN ALAT | DPIB SMKN2TB</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;600;700&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            /* Perubahan warna background: tidak terlalu gelap, tidak terlalu terang */
            --bg-dark: #374151;      
            --bg-panel: #1f2937;     
            --safety-yellow: #facc15; 
            --tech-blue: #0ea5e9;    
            --text-light: #f3f4f6;
            --grid-color: rgba(255, 255, 255, 0.05);
        }

        body {
            font-family: 'Chakra Petch', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-light);
            background-image: 
                linear-gradient(var(--grid-color) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid-color) 1px, transparent 1px);
            background-size: 40px 40px;
            overflow-x: hidden;
        }

        .scan-bar {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10; 
            background: linear-gradient(to bottom, transparent 0%, rgba(255, 255, 255, 0.1) 0.05%, transparent 0.1%);
            background-size: 100% 200vh; 
            animation: scan-move 10s linear infinite; 
            pointer-events: none;
        }

        @keyframes scan-move {
            0% { transform: translateY(-100vh); }
            100% { transform: translateY(100vh); }
        }

        .font-data { font-family: 'Roboto Mono', monospace; }

        .caution-stripes {
            background: repeating-linear-gradient(45deg, #000, #000 10px, #facc15 10px, #facc15 20px);
        }

        .header-industrial {
            background-color: #111827;
            border-bottom: 4px solid var(--safety-yellow);
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            z-index: 50; position: sticky; top: 0;
        }

        .card-industrial {
            background: var(--bg-panel);
            border: 1px solid #4b5563;
            position: relative; z-index: 30; 
            transition: all 0.3s ease;
            clip-path: polygon(0 0, 100% 0, 100% 85%, 90% 100%, 0 100%);
        }
        
        .card-industrial:hover {
            transform: translateY(-5px);
            border-color: var(--safety-yellow);
            box-shadow: 0 10px 30px rgba(250, 204, 21, 0.1);
        }

        input, select, textarea {
            background-color: #111827;
            border: 1px solid #4b5563;
            color: white;
            font-family: 'Roboto Mono', monospace;
            border-left: 3px solid var(--tech-blue);
        }
        input:focus, select:focus {
            outline: none; border-color: var(--safety-yellow); background-color: #1f2937;
        }

        .btn-submit {
            background-color: var(--tech-blue);
            color: black;
            font-weight: 800; text-transform: uppercase; border-bottom: 4px solid #0284c7;
        }

        .tech-table th {
            background-color: #111827;
            color: var(--safety-yellow);
            border-bottom: 2px solid var(--safety-yellow);
        }
        .tech-table td { border-bottom: 1px solid #374151; padding: 12px; }

        .blink-green { animation: blink-anim 1.5s infinite; background-color: #22c55e; }
        
        @keyframes blink-anim {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        .hidden { display: none !important; }
        
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        #search-results {
            position: absolute; width: 100%; max-height: 200px;
            overflow-y: auto; background: #111827; border: 1px solid #4b5563;
            z-index: 100; margin-top: 1px;
        }
        .search-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #374151; }
        .search-item:hover { background-color: var(--tech-blue); color: black; }

        .step-slide { display: none; }
        .step-slide.active { display: block; animation: slideIn 0.3s ease-out; }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col relative">

    <div class="scan-bar"></div>

    <header class="header-industrial">
        <div class="h-2 w-full caution-stripes"></div>
        <div class="container mx-auto p-4 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-4 w-full md:w-auto border-l-4 border-blue-500 pl-4 bg-white/5 p-2">
                <img src="logosmk.png" onerror="this.src='https://via.placeholder.com/64?text=SMK'" alt="Logo SMK" class="w-16 h-16 object-contain">
                <div>
                    <h1 class="text-3xl font-bold text-white tracking-tighter uppercase leading-none">SMKN 2 TERBANGGI BESAR</h1>
                    <div class="flex items-center gap-2 mt-1">
                        <span class="bg-blue-600 text-white text-[10px] font-bold px-1 py-0.5 rounded">PRODI</span>
                        <p class="text-sm text-yellow-400 font-bold tracking-wide">DESAIN PEMODELAN DAN INFORMASI BANGUNAN</p>
                    </div>
                </div>
            </div>

            <div class="w-full md:w-auto flex items-center justify-between md:justify-end gap-4 bg-black/40 p-2 rounded border border-gray-700">
                <div class="flex flex-col items-end mr-2">
                    <div class="flex items-center gap-2 mb-1">
                        <span class="text-xs font-bold text-gray-400 uppercase tracking-widest">firebase Status</span>
                        <div class="flex items-center gap-1 bg-black px-2 py-1 rounded border border-green-900">
                            <div class="w-3 h-3 rounded-full blink-green"></div>
                            <span class="text-green-500 font-bold text-xs">CONNECTED</span>
                        </div>
                    </div>
                </div>
                <div class="text-right border-l border-gray-600 pl-4">
                    <div id="realtime-clock" class="text-xl font-data font-bold text-white leading-none">00:00</div>
                    <div id="realtime-date" class="text-[10px] text-blue-400 font-bold mt-1 uppercase">...</div>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-grow container mx-auto p-6 md:p-10">
        <!-- DASHBOARD -->
        <section id="page-dashboard" class="fade-in">
            <div class="flex items-center gap-4 mb-8">
                <div class="h-8 w-2 bg-yellow-500"></div>
                <h2 class="text-2xl font-bold text-white uppercase tracking-widest">DPIB INVENTORY SYSTEM</h2>
                <div class="h-px bg-gray-700 flex-grow"></div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 max-w-6xl mx-auto">
                <button onclick="showPage('peminjaman')" class="card-industrial p-8 text-left group">
                    <div class="flex justify-between items-start mb-4">
                        <div class="bg-blue-900/30 p-4 rounded border border-blue-500/50 group-hover:bg-blue-600">
                            <i class="fa-solid fa-pen-ruler text-4xl text-blue-400 group-hover:text-white"></i>
                        </div>
                    </div>
                    <h3 class="text-xl font-bold text-white mb-2 group-hover:text-yellow-400 uppercase">Peminjaman Alat</h3>
                    <p class="text-sm text-gray-400">Input data peminjaman baru via Stepper UI.</p>
                </button>
                <button onclick="showPage('pengembalian')" class="card-industrial p-8 text-left group">
                    <div class="flex justify-between items-start mb-4">
                        <div class="bg-yellow-900/30 p-4 rounded border border-yellow-500/50 group-hover:bg-yellow-600">
                            <i class="fa-solid fa-clipboard-check text-4xl text-yellow-400 group-hover:text-white"></i>
                        </div>
                    </div>
                    <h3 class="text-xl font-bold text-white mb-2 group-hover:text-yellow-400 uppercase">Pengembalian Alat</h3>
                    <p class="text-sm text-gray-400">Monitoring dan checklist pengembalian.</p>
                </button>
                <button onclick="showPage('pemakaian')" class="card-industrial p-8 text-left group">
                    <div class="flex justify-between items-start mb-4">
                        <div class="bg-gray-800 p-4 rounded border border-gray-500 group-hover:bg-gray-600">
                            <i class="fa-solid fa-file-csv text-4xl text-gray-400 group-hover:text-white"></i>
                        </div>
                    </div>
                    <h3 class="text-xl font-bold text-white mb-2 group-hover:text-yellow-400 uppercase">Rekap Data</h3>
                    <p class="text-sm text-gray-400">Admin access area.</p>
                </button>
            </div>
        </section>

        <!-- PAGE PEMINJAMAN -->
        <section id="page-peminjaman" class="hidden max-w-6xl mx-auto fade-in">
            <div class="flex justify-between items-center mb-6">
                <button onclick="showPage('dashboard')" class="flex items-center gap-2 text-gray-200 hover:text-white font-bold uppercase text-sm">
                    <i class="fa-solid fa-arrow-left bg-gray-800 p-2 rounded"></i> Kembali
                </button>
                <div class="text-right">
                    <h2 class="text-2xl font-bold text-blue-400 uppercase">Form Peminjaman</h2>
                    <p class="text-[10px] text-gray-400 font-bold tracking-widest">SISTEM POP-UP STEPPER ACTIVE</p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                <div class="lg:col-span-12 bg-[#1f2937] p-8 border-t-4 border-blue-500 shadow-lg">
                    <label class="block text-xs font-bold text-blue-400 mb-2 uppercase tracking-widest">Cari Nama Peminjam</label>
                    <div class="relative max-w-2xl">
                        <input type="text" id="search-nama" placeholder="[Ketik nama siswa]" class="w-full p-4 text-lg bg-black border-l-8 border-yellow-500 uppercase font-black tracking-tighter">
                        <div id="search-results" class="hidden shadow-2xl"></div>
                    </div>
                    <p class="text-[10px] text-gray-400 mt-3 italic uppercase">Sistem akan otomatis membuka jendela input setelah nama dipilih.</p>
                </div>

                <div class="lg:col-span-12 bg-[#1f2937] flex flex-col border-t-4 border-yellow-500 mt-6 shadow-lg">
                    <div class="p-4 border-b border-gray-700 bg-black/20 flex justify-between items-center">
                        <h3 class="text-sm font-bold text-yellow-500 uppercase flex items-center gap-2">
                            <i class="fa-solid fa-list-check"></i> LIST DATA READY (<span id="count-antrean">0</span>)
                        </h3>
                        <button onclick="clearAntrean()" class="text-[10px] text-red-400 font-bold uppercase underline">Clear All Data</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full tech-table font-data text-xs">
                            <thead>
                                <tr class="bg-black">
                                    <th class="p-3 text-left">Peminjam</th>
                                    <th class="p-3 text-left">Detail Alat</th>
                                    <th class="p-3 text-center">Kode</th>
                                    <th class="p-3 text-center">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="list-antrean-body" class="divide-y divide-gray-800">
                                <tr><td colspan="4" class="p-10 text-center text-gray-400 italic">Belum ada data di antrean.</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="p-4 bg-black/40">
                        <button type="button" id="btn-save-firebase" disabled class="btn-submit w-full py-4 opacity-50 cursor-not-allowed flex justify-center items-center gap-2">
                            <i class="fa-solid fa-cloud-arrow-up"></i> SIMPAN KE DATABASE
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- PAGE PENGEMBALIAN -->
        <section id="page-pengembalian" class="hidden max-w-6xl mx-auto fade-in">
             <div class="flex justify-between items-center mb-6">
                <button onclick="showPage('dashboard')" class="flex items-center gap-2 text-gray-200 hover:text-white font-bold uppercase text-sm">
                    <i class="fa-solid fa-arrow-left bg-gray-800 p-2 rounded"></i> KEMBALI
                </button>
                <h2 class="text-2xl font-bold text-yellow-500 uppercase">PENGEMBALIAN</h2>
            </div>
            <div class="bg-[#1f2937] border border-gray-700 p-1 shadow-xl">
                <div class="bg-black/50 p-3 grid grid-cols-1 md:grid-cols-2 gap-4 border-b border-gray-700 mb-4">
                    <!-- Penambahan Fitur Search by Name & Search by Code -->
                    <div>
                        <label class="text-[10px] text-gray-400 font-bold uppercase block mb-1">Search by Name</label>
                        <input type="text" id="cari-nama-kembali" oninput="filterTabelKembali()" placeholder="Nama Siswa..." class="w-full bg-gray-800 text-xs p-2 rounded uppercase border-l-2 border-yellow-500">
                    </div>
                    <div>
                        <label class="text-[10px] text-gray-400 font-bold uppercase block mb-1">Search by Code</label>
                        <input type="text" id="cari-kode-kembali" oninput="filterTabelKembali()" placeholder="Kode Alat..." class="w-full bg-gray-800 text-xs p-2 rounded uppercase border-l-2 border-blue-500">
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-xs tech-table font-data">
                        <thead>
                            <tr>
                                <th class="w-10 text-center"><i class="fa-regular fa-square-check"></i></th>
                                <th>Tanggal</th>
                                <th>Nama Peminjam</th>
                                <th>Alat</th>
                                <th class="text-center">Kode</th>
                                <th class="text-center">Status</th>
                            </tr>
                        </thead>
                        <tbody id="tabel-peminjaman"></tbody>
                    </table>
                </div>
                <div class="mt-8 bg-gray-800 p-6 border-t-4 border-yellow-500">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                        <select id="return-condition" class="w-full p-3 bg-black border border-gray-600 text-white">
                            <option value="OK">KONDISI: OK</option>
                            <option value="NG">KONDISI: RUSAK (NG)</option>
                            <option value="HILANG">KONDISI: HILANG</option>
                        </select>
                        <input type="password" id="admin-password" placeholder="PASSWORD ADMIN" class="w-full p-3 bg-black border border-gray-600 text-center">
                        <button id="btn-return-firebase" class="w-full bg-yellow-500 text-black font-black py-3 uppercase">PROSES KEMBALI</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- PAGE REKAP -->
        <section id="page-pemakaian" class="hidden max-w-4xl mx-auto pt-10 text-center">
             <button onclick="showPage('dashboard')" class="mb-8 text-gray-200 hover:text-white font-bold uppercase text-sm">Kembali</button>
             <div class="bg-gray-800 p-12 border border-gray-600 shadow-2xl">
                <div id="admin-lock-screen">
                    <i class="fa-solid fa-lock text-5xl text-red-500 mb-4"></i>
                    <h2 class="text-2xl font-bold text-white mb-6 uppercase">RESTRICTED AREA</h2>
                    <input type="password" id="download-auth-pass" placeholder="Password..." class="p-3 bg-black border border-gray-500 text-white mb-4 block mx-auto">
                    <button onclick="verifyAdminDownload()" class="bg-red-600 text-white px-8 py-2 font-bold uppercase">Unlock</button>
                </div>
                <div id="admin-download-area" class="hidden">
                    <i class="fa-solid fa-file-csv text-6xl text-green-500 mb-4"></i>
                    <button onclick="downloadLaporanCSV()" class="px-8 py-4 bg-green-700 text-white font-bold uppercase">Download CSV Rekap</button>
                </div>
             </div>
        </section>
    </main>

    <!-- STEPPER MODAL -->
    <div id="stepper-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4">
        <div class="bg-black/90 absolute inset-0 backdrop-blur-md"></div>
        <div class="relative z-10 w-full max-w-lg bg-[#111827] border-2 border-blue-500 shadow-[0_0_50px_rgba(14,165,233,0.3)]">
            <div class="caution-stripes h-2 w-full"></div>
            <div class="p-6">
                <div id="step-identity-display" class="mb-6 border-l-4 border-yellow-500 pl-4 bg-white/5 p-3">
                    <h4 id="display-nama" class="text-xl font-black text-white uppercase leading-none">-</h4>
                    <p id="display-kelas-jurusan" class="text-[10px] text-blue-400 font-bold tracking-widest mt-1">-</p>
                </div>

                <div id="step-1" class="step-slide">
                    <h3 class="text-sm font-bold text-gray-400 mb-4 uppercase italic">Data Identitas Manual</h3>
                    <input type="text" id="manual-nama" placeholder="NAMA" class="w-full p-3 mb-3 uppercase">
                    <div class="grid grid-cols-2 gap-2">
                        <input type="text" id="manual-kelas" placeholder="KELAS / JURUSAN" class="p-3 uppercase">
                        <input type="text" id="manual-jurusan" placeholder="DEPARTEMEN / AREA" class="p-3 uppercase">
                    </div>
                    <button onclick="nextStep(2)" class="w-full mt-6 bg-blue-600 py-3 font-bold text-white uppercase">Lanjut Pilih Alat</button>
                </div>

                <div id="step-2" class="step-slide">
                    <h3 class="text-sm font-bold text-gray-400 mb-4 uppercase">Pilih Alat Inventaris</h3>
                    <div class="grid grid-cols-2 gap-2 mb-4">
                        <button onclick="selectAlat('PENGGARIS')" class="p-4 bg-black border border-gray-700 hover:border-blue-500 text-xs font-bold uppercase">Penggaris</button>
                        <button onclick="selectAlat('KALKULATOR')" class="p-4 bg-black border border-gray-700 hover:border-blue-500 text-xs font-bold uppercase">Kalkulator</button>
                        <button onclick="selectAlat('MOUSE')" class="p-4 bg-black border border-gray-700 hover:border-blue-500 text-xs font-bold uppercase">Mouse</button>
                        <button onclick="selectAlat('KEYBOARD')" class="p-4 bg-black border border-gray-700 hover:border-blue-500 text-xs font-bold uppercase">Keyboard</button>
                    </div>
                    <input type="text" id="manual-alat" placeholder="Input nama alat lainnya" class="w-full p-3 uppercase text-sm border-yellow-500">
                    <button onclick="nextStep(3)" class="w-full mt-6 bg-blue-600 py-3 font-bold text-white uppercase">Lanjut ke Detail</button>
                </div>

                <div id="step-3" class="step-slide">
                    <h3 class="text-sm font-bold text-gray-400 mb-4 uppercase">Detail Peminjaman</h3>
                    <div class="mb-4">
                        <label class="text-[10px] font-bold text-gray-500 block mb-1">JUMLAH ALAT</label>
                        <input type="number" id="stepper-jumlah" value="1" min="1" class="w-full p-4 text-center text-xl font-bold">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-gray-500 block mb-1">NO. KODE ALAT</label>
                        <input type="text" id="stepper-kode" placeholder="[NOMOR / KODE ALAT]" class="w-full p-4 text-center text-xl font-bold border-yellow-500 text-yellow-400 uppercase">
                    </div>
                    <button onclick="addToQueue()" class="w-full mt-6 bg-yellow-500 py-4 font-black text-black uppercase text-lg">TAMBAH KE DAFTAR</button>
                </div>
            </div>
            <button onclick="closeStepper()" class="absolute -top-4 -right-4 bg-red-600 w-10 h-10 rounded-full text-white flex items-center justify-center border-4 border-[#1a1a1a]"><i class="fa-solid fa-xmark"></i></button>
        </div>
    </div>

    <!-- MODAL NOTIF -->
    <div id="custom-modal" class="fixed inset-0 z-[200] hidden flex items-center justify-center p-4">
        <div class="bg-black/80 absolute inset-0"></div>
        <div class="relative z-10 w-full max-w-sm bg-[#1f2937] border-2 border-white p-6 text-center shadow-2xl">
            <h3 id="modal-title" class="font-bold text-white mb-2 uppercase"></h3>
            <p id="modal-message" class="text-gray-400 text-sm mb-6"></p>
            <button onclick="closeModal()" class="w-full bg-white text-black py-2 font-bold uppercase">Tutup</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, updateDoc, query, where, writeBatch, setDoc, getDocs, orderBy } 
        from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyDDHwbFq1rFoSImy3I8g3O820vV_sPdEHE",
          authDomain: "dpib-system-v2.firebaseapp.com",
          projectId: "dpib-system-v2",
          storageBucket: "dpib-system-v2.firebasestorage.app",
          messagingSenderId: "444034231596",
          appId: "1:444034231596:web:087a500225bffabe7d5089"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.db = db;
        window.writeBatch = writeBatch;
        window.collection = collection;
        window.doc = doc;
        window.setDoc = setDoc;
        window.getDocs = getDocs;
        window.query = query;
        window.orderBy = orderBy;
        window.updateDoc = updateDoc;

        window.databaseSiswa = {
            "X-DPIB-1": ["ADAM ILHAM DARMAWAN", "AGUNG SATRIA UTAMA", "AGUSTINA", "AINUL MARDIAH", "ALDIANO AFANDY", "ALI FAHMI SETIOSO", "AMELIA BUNGA SAFITRI", "ANDIKA DWI SAPUTRA", "ARI NANDA FEFRIAN", "BAYU AHMAD NUR IMAN", "CHANDRA WIRA ATMAJA", "DAFFA SAUQI", "DEBY ORLANDO PRATAMA", "DINO AFRIAN", "DZAIDAN AKMAL PRATAMA", "EKA SETYAWAN", "ELSYA ALFIANI", "FADLAN NABIL RIFQI SYAFIQ", "FHAREL HARDINATA M. NUR", "HANDY RYDHO WIJAYA", "IKA AGUSTINA", "INTAN NURAINI", "JANA SURYANA", "KHARISMA DINDA RAMADHANI", "M. LUTHFI MAULANA", "MUHAMMAD FADLI", "MUHAMMAD HAIQAL", "NESYA NANDINI", "NUUR MIFTAHUL JAUHAR", "PUTRI ADELINA FERANI", "PUTRI TANSYIER DEWI", "RAKA DRIMAHEZA", "RAYHAN RAYNANDA", "REHAN ADI PRASETIO", "RIKO ALFANANDO", "SHAFIRA NUR AZIZAH", "VIKA HERAWATI"],
            "X-DPIB-2": ["ADONIS NANDHITO", "AGUSTIAN FERNANDO", "AIKO ALVIZAUDRI KENATRA", "AKHMAD RIZKY MURTADO", "ALFINO PRAMANTA", "ALIFAH KUSUMA WARDANI", "ANDHIKA AZIZ PRATAMA", "ARETHA ZHIE ZHIE. S", "AULIA FEBRIYANA", "CAHAYA PUTRI MARIONA", "CHILA VIECHO NURHIDAYAH", "DAVA DANIL PARESA", "DIKA SAPUTRA", "DIVA APRILIA", "EKA PUTRA WIJAYA", "ELLAS TIRTA SAVANA", "FAIZ AL QORNI HAKIM", "GILANG SETIA AN", "HAFIZAH SETIA RAMADANI", "HENKY TRIYAN SYAH", "ILHAM DINATA", "JAENAL SOBIRIN", "KAYLA KANIA ALVIONA", "LUTHFI HANIF", "MELA NOVALIA", "MUHAMMAD FAHRI", "MUHAMMAD RAFLY AL - FAHREZY", "NINO OKTAVIANO SAPUTRA", "OSCHAR PARULIAN TAMPUBOLON", "PUTRI FEBRIANI", "RAHMAD RAMADAN", "RAMDA WIRAKKA PRATAMA", "REFAL FIRMANSYAH", "RIKA SAPUTRI", "SELFI MEDIARI A.ZYAHRA", "THOLIB ABDUL ALIM", "ZAHRA AMELIA"],
            "XI-DPIB-1": ["ABI DWI ARYANSYAH", "ADRIAN JULY SAPUTRA", "AGNES FIDELA ASMARA", "AHMAD FAQIH HUNTELAAR", "AININ DINIYA HAQQI", "ALVIN ANDRY PRATAMA", "ANGGIA FAULINA", "AZZAHRA KAYLA NURANISA", "BAGUS TRI PUJIANTO", "CELVIN NIKO PRATAMA", "DANI FIRMANSYAH", "DIKA PRATAMA", "FADLAN NABIL RIFQI SYAFIQ", "FAJAR DZULKARNAEN", "FAQIH PANDU IRAWAN", "FARIZ ARDIANTORO", "GEVHANDRA MILANDO", "HENDRA KURNIAWAN", "INTAN BARO MAHARANI", "KEYSIA PUTRI HANDAYANI", "MARCEL ADITYA", "MELIANA TISTA", "MUHAMAD FAREL RADITYA", "MUHAMMAD AGIL SAPUTRA", "MUHAMMAD ASFA ALDIKA", "MUHAMMAD HAFFIYAN ZASIN", "NINGRUM NUR ANNISA", "RADITYA TEGAR", "RAFFI GALIH PRASETYO", "RAKA RESKIADITIA HALTARA", "RIO ZET MIKO", "ROMULA RAJIDIN SYAKURTA", "SYAMSUL ANWAR ARAFI", "VINZA ADITYA RAMADHAN"],
            "XI-DPIB-2": ["ADZKIA PURNOMO", "AFDAL NUR ROHIM", "AISYA AZZAHRA SINTIA", "ANDI SETIAWAN", "ARBA FIRMANSYAH", "ARDA JEPRIYAN SYACH", "AZIZ MAULANA ISHAK", "DIKKY DWI WIBOWO", "FADLI AZKA RAMANDIKA", "FAHRIZA RISWANDI", "FAREL PUTRA RAMADHAN", "GILANG SETIA AN", "INKA NABILA", "INNA RAFFA FIRIZKU SUBING", "IRWAN SAPUTRA", "MUHAMMAD IQBAL MAULANA", "MUHAMMAD NANDA ARYA REZA", "MUHAMMAD SYAHRUL MUNIR", "MUHAMMAD TAUFIQUZZIYAD", "NAIFA MEZZALUNA RAMADHANI", "NOVAL KHOIRUL EFENDI", "PANDU ADJIE DINATA", "QOIS NUR RAHMAN", "RAMA YOGA PRATAMA", "REFI ARTIKASARI", "RISKA RAHMAWARDANI", "RIZKY ADITYA", "RIZKY PRATAMA", "SITI RAHMAWATI", "SULTAN PASHA ALTAFA", "TIRTA NUR KHOIRUDIN", "VENY FERAWATI", "YUSUF RAMA WINATA", "ZHULFA ANISA RAYIKINANTI"],
            "XII-DPIB-1": ["AGUS MAULANA IKHSAN", "APRILIA DWI LESTARI", "AZ ZAHRA ANNISA", "CAHAYA WULANDARI", "CLAUDIA DHIZA SHEZA MALIKA", "DAMAR DWI BIMANDIKA", "DUWI NOFI WULANDARI", "LARASATI CAHYANING PUTRI HERNADI", "MUHAMAD LUTFI PRATAMA", "MUHAMMAD IHCAN ILHAM", "MUHAMMAD RIZKY", "NADIA NURUL AFIFA", "NAWANG AUFA QUROTA AKYUN", "QURROTA A'YUN", "RAIHAN HAKIM", "WANTI RAHMADANI", "WIDYA FADILLA ALBADRI", "AGNA KHOIRUL NISA", "ALL SHELLA VIERRANITHA AGLISKA", "CITRA ASTI MUTIA", "DAFFA KHUSNUREZA", "DAVA PURNIAWANDA", "DINI RAHMADANI", "EGI LISTIANTI", "FINKA INDAH ANGGRAINI", "HERLIZA AWANDA OCTARA", "KEYSHA ALLIFIA KHAIRUNISA", "M. PASYA FAUZI SOPIAN", "MUHAMMAD DHAFA", "RADITYA FEBRIANZA RIZANTHA", "RAFI DEBI ASMARA", "RENO ANDRE SAPUTRA", "REZA NURUL SAFITRI", "SAFIRA", "VIRGIAWAN LISTIANTO"],
            "XII-DPIB-2": ["ADLY YOVI SAPUTRA", "ANDREA DWI FERLIANSYAH", "BAYHAQQI RAFLI", "BAYU CATUR WIJANARKO", "GALANG SATRIA PUTRA", "IQBAL FERDIANSYAH", "LEO CHANDRA JAYA KESUMA", "LUCKY HERMAWAN", "MAULANA ABIYYU FAQIH", "MUHAMMAD FANI PRAJA MANDALA", "MUHAMMAD RAIHAN WIRAYUDA", "MUHAMMAD RISKY SYAPUTRA", "NABILA", "NASYA RAHMAWATI", "NESYA KURNIA SARI", "RAMADHAN ERLANG KHADAFI", "REVAN SEBASTIAN BELANDRI", "SISKA ANGGRAINI", "ADIKA ANANTA RAMLI", "AGAM PRASETIA JAYA", "ALIF DWI KUNCORO", "ALIFIA AULIA AMANDA", "ARIA AGUNG PRASETIO", "DIMAS MUHAMMAD AFRIZAL", "DUWI SANTIKA", "ESTER ROMAULI SIMATUPANG", "FIBRI LYIANA", "GALANG SAPUTRA", "GLEND ANDIKA PRATAMA", "GUSTI SONA ZULYAN PRATAMA", "HAYDEN RIO SAPUTRA", "MUHAMAD ARIF ALDO MAULANA", "NOVITA SARI", "PIRMANSYAH", "ROMLI AFFANDI", "YUNITA AGUSTINA"]
        };

        window.listAntrean = [];

        const q = query(collection(db, "peminjaman_dpib"), where("status", "==", "DIPINJAM"));
        onSnapshot(q, (snapshot) => {
            const tbody = document.getElementById('tabel-peminjaman');
            tbody.innerHTML = '';
            snapshot.forEach(doc => {
                const item = doc.data();
                tbody.innerHTML += `
                    <tr class="row-peminjaman">
                        <td class="text-center"><input type="checkbox" class="checkbox-kembali accent-yellow-500" value="${doc.id}"></td>
                        <td class="font-data">${item.tanggal}</td>
                        <td class="font-bold cell-nama">${item.nama} <br> <span class="text-blue-500 font-normal">${item.kelas} ${item.jurusan || ''}</span></td>
                        <td class="text-yellow-500">${item.alat}</td>
                        <td class="text-center font-bold cell-kode">${item.kode}</td>
                        <td class="text-center"><span class="bg-red-900 text-white px-2 py-0.5 rounded text-[10px]">PINJAM</span></td>
                    </tr>
                `;
            });
            // Jalankan filter setelah snapshot update jika sedang mengetik
            filterTabelKembali();
        });
    </script>

    <script>
        let currentStep = 1;
        let selectedPeminjam = { nama: '', kelas: '', jurusan: '' };
        let selectedAlatName = '';

        const searchInput = document.getElementById('search-nama');
        const searchResults = document.getElementById('search-results');

        searchInput.addEventListener('input', function() {
            const val = this.value.toLowerCase();
            searchResults.innerHTML = '';
            if (!val) { searchResults.classList.add('hidden'); return; }

            let matches = [];
            for (let key in window.databaseSiswa) {
                const parts = key.split('-');
                window.databaseSiswa[key].forEach(nama => {
                    if (nama.toLowerCase().includes(val)) {
                        matches.push({ nama, kelas: parts[0], jur: parts[1] + (parts[2] ? '-' + parts[2] : '') });
                    }
                });
            }
            searchResults.classList.remove('hidden');

            matches.slice(0, 8).forEach(m => {
                const div = document.createElement('div');
                div.className = 'search-item';
                div.innerHTML = `<span class="font-bold">${m.nama}</span> <span class="text-[10px] text-gray-500">(${m.kelas} ${m.jur})</span>`;
                div.onclick = () => {
                    openStepper(m.nama, m.kelas, m.jur);
                    searchResults.classList.add('hidden');
                    searchInput.value = '';
                };
                searchResults.appendChild(div);
            });

            const manual = document.createElement('div');
            manual.className = 'search-item text-yellow-500 font-bold border-t border-gray-700';
            manual.innerHTML = 'INPUT MANUAL (LAINNYA)';
            manual.onclick = () => {
                openStepper('', '', '', true);
                searchResults.classList.add('hidden');
                searchInput.value = '';
            };
            searchResults.appendChild(manual);
        });

        // Filter Function untuk Pengembalian Alat
        function filterTabelKembali() {
            const namaFilter = document.getElementById('cari-nama-kembali').value.toLowerCase();
            const kodeFilter = document.getElementById('cari-kode-kembali').value.toLowerCase();
            const rows = document.querySelectorAll('.row-peminjaman');

            rows.forEach(row => {
                const nama = row.querySelector('.cell-nama').innerText.toLowerCase();
                const kode = row.querySelector('.cell-kode').innerText.toLowerCase();
                
                if (nama.includes(namaFilter) && kode.includes(kodeFilter)) {
                    row.style.display = "";
                } else {
                    row.style.display = "none";
                }
            });
        }

        function openStepper(nama, kelas, jur, isManual = false) {
            currentStep = isManual ? 1 : 2;
            selectedPeminjam = { nama, kelas, jurusan: jur };
            document.getElementById('display-nama').innerText = nama || 'MANUAL INPUT';
            document.getElementById('display-kelas-jurusan').innerText = (kelas ? `${kelas} ${jur}` : 'SILAKAN ISI IDENTITAS');
            document.getElementById('stepper-modal').classList.remove('hidden');
            showStep(currentStep);
        }

        function showStep(s) {
            document.querySelectorAll('.step-slide').forEach(el => el.classList.remove('active'));
            document.getElementById('step-' + s).classList.add('active');
        }

        function nextStep(s) {
            if (s === 2 && currentStep === 1) {
                selectedPeminjam.nama = document.getElementById('manual-nama').value;
                selectedPeminjam.kelas = document.getElementById('manual-kelas').value;
                selectedPeminjam.jurusan = document.getElementById('manual-jurusan').value;
                if(!selectedPeminjam.nama) return showModal('ERROR', 'Nama harus diisi', 'error');
                document.getElementById('display-nama').innerText = selectedPeminjam.nama;
                document.getElementById('display-kelas-jurusan').innerText = `${selectedPeminjam.kelas} ${selectedPeminjam.jurusan}`;
            }
            currentStep = s;
            showStep(s);
        }

        function selectAlat(alat) {
            selectedAlatName = alat;
            document.getElementById('manual-alat').value = alat;
            nextStep(3);
        }

        function addToQueue() {
            const alat = document.getElementById('manual-alat').value.toUpperCase();
            const jumlahRaw = document.getElementById('stepper-jumlah').value;
            const kode = document.getElementById('stepper-kode').value.toUpperCase();
            if (!alat || !kode) { showModal('GAGAL', 'Alat dan Kode wajib diisi!', 'error'); return; }
            const data = {
                nama: selectedPeminjam.nama,
                kelas: selectedPeminjam.kelas,
                jurusan: selectedPeminjam.jurusan,
                alat: alat,
                jumlah: jumlahRaw + " Unit",
                kode: kode,
                tanggal: new Date().toISOString().split('T')[0],
                status: 'DIPINJAM',
                timestamp: new Date()
            };
            window.listAntrean.push(data);
            updateAntreanUI();
            closeStepper();
        }

        function updateAntreanUI() {
            const body = document.getElementById('list-antrean-body');
            const count = document.getElementById('count-antrean');
            const btn = document.getElementById('btn-save-firebase');
            count.innerText = window.listAntrean.length;
            if (window.listAntrean.length === 0) {
                body.innerHTML = '<tr><td colspan="4" class="p-10 text-center text-gray-400 italic">Belum ada data di antrean.</td></tr>';
                btn.disabled = true;
                btn.classList.add('opacity-50');
            } else {
                body.innerHTML = '';
                window.listAntrean.forEach((item, i) => {
                    body.innerHTML += `
                        <tr class="hover:bg-white/5">
                            <td class="p-3">
                                <span class="font-bold text-blue-400">${item.nama}</span><br>
                                <span class="text-[9px] text-gray-400">${item.kelas} ${item.jurusan || ''}</span>
                            </td>
                            <td class="p-3">${item.alat} (${item.jumlah})</td>
                            <td class="p-3 text-center text-yellow-500 font-bold">${item.kode}</td>
                            <td class="p-3 text-center flex items-center justify-center gap-4">
                                <button onclick="editFromQueue(${i})" class="text-blue-400 hover:text-blue-300"><i class="fa-solid fa-pen-to-square"></i></button>
                                <button onclick="removeFromQueue(${i})" class="text-red-500 hover:text-red-400"><i class="fa-solid fa-trash"></i></button>
                            </td>
                        </tr>
                    `;
                });
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        window.editFromQueue = (i) => {
            const item = window.listAntrean[i];
            selectedPeminjam = { nama: item.nama, kelas: item.kelas, jurusan: item.jurusan };
            document.getElementById('manual-nama').value = item.nama;
            document.getElementById('manual-kelas').value = item.kelas;
            document.getElementById('manual-jurusan').value = item.jurusan;
            document.getElementById('manual-alat').value = item.alat;
            document.getElementById('stepper-jumlah').value = item.jumlah.split(' ')[0];
            document.getElementById('stepper-kode').value = item.kode;
            document.getElementById('display-nama').innerText = item.nama;
            document.getElementById('display-kelas-jurusan').innerText = `${item.kelas} ${item.jurusan}`;
            window.listAntrean.splice(i, 1);
            updateAntreanUI();
            document.getElementById('stepper-modal').classList.remove('hidden');
            showStep(3);
        };

        window.removeFromQueue = (i) => { window.listAntrean.splice(i, 1); updateAntreanUI(); };
        window.clearAntrean = () => { window.listAntrean = []; updateAntreanUI(); };

        document.getElementById('btn-save-firebase').addEventListener('click', async () => {
            const btn = document.getElementById('btn-save-firebase');
            btn.innerText = "SEDANG MENGIRIM...";
            btn.disabled = true;
            try {
                const batch = window.writeBatch(window.db);
                window.listAntrean.forEach(data => {
                    const docId = `${data.nama}_${data.kode}`.replace(/\s+/g, '_');
                    const ref = window.doc(window.db, "peminjaman_dpib", docId);
                    batch.set(ref, data);
                });
                await batch.commit();
                window.listAntrean = [];
                updateAntreanUI();
                showModal('SUKSES', 'Data tersimpan ke database.', 'success');
            } catch (e) {
                showModal('ERROR', 'Gagal simpan ke database.', 'error');
            } finally {
                btn.innerText = "SIMPAN SEMUA KE DATABASE";
            }
        });

        function closeStepper() {
            document.getElementById('stepper-modal').classList.add('hidden');
            document.getElementById('stepper-kode').value = '';
            document.getElementById('stepper-jumlah').value = '1';
            document.getElementById('manual-alat').value = '';
            document.getElementById('manual-nama').value = '';
            document.getElementById('manual-kelas').value = '';
            document.getElementById('manual-jurusan').value = '';
        }

        function showPage(p) {
            ['dashboard', 'peminjaman', 'pengembalian', 'pemakaian'].forEach(id => document.getElementById('page-'+id).classList.add('hidden'));
            document.getElementById('page-'+p).classList.remove('hidden');
        }

        function updateClock() {
            const now = new Date();
            document.getElementById('realtime-clock').innerText = now.toLocaleTimeString('id-ID', {hour12: false});
            document.getElementById('realtime-date').innerText = now.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }).toUpperCase();
        }
        setInterval(updateClock, 1000);

        function showModal(title, msg, type) {
            document.getElementById('custom-modal').classList.remove('hidden');
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-message').innerText = msg;
        }
        function closeModal() { document.getElementById('custom-modal').classList.add('hidden'); }

        window.verifyAdminDownload = () => {
            if(document.getElementById('download-auth-pass').value === 'lab15.30') {
                document.getElementById('admin-lock-screen').classList.add('hidden');
                document.getElementById('admin-download-area').classList.remove('hidden');
            }
        };

        window.downloadLaporanCSV = async () => {
            const q = window.query(window.collection(window.db, "peminjaman_dpib"), window.orderBy("timestamp", "desc"));
            const snap = await window.getDocs(q);
            let csv = "Tanggal,Nama,Kelas,Jurusan,Alat,Kode,Status\n";
            snap.forEach(d => {
                const a = d.data();
                csv += `${a.tanggal},${a.nama},${a.kelas},${a.jurusan || ''},${a.alat},${a.kode},${a.status}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'REKAP_DPIB.csv'; a.click();
        };

        document.getElementById('btn-return-firebase').addEventListener('click', async () => {
            if(document.getElementById('admin-password').value !== 'lab15.30') return showModal('ERROR', 'Sandi Salah', 'error');
            const checks = document.querySelectorAll('.checkbox-kembali:checked');
            if(checks.length === 0) return showModal('ERROR', 'Pilih minimal satu data', 'error');
            for(let c of checks) {
                await window.updateDoc(window.doc(window.db, "peminjaman_dpib", c.value), {
                    status: 'DIKEMBALIKAN',
                    tgl_kembali: new Date().toISOString().split('T')[0],
                    kondisi_kembali: document.getElementById('return-condition').value
                });
            }
            showModal('SUKSES', 'Status diperbarui', 'success');
            document.getElementById('admin-password').value = '';
        });
    </script>
</body>
</html>

