<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DPIB SYSTEM V.3.3 - INDUSTRIAL (EXTERNAL USER SUPPORT)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;600;700&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- TEMA: INDUSTRIAL ENGINEERING / DPIB (ORIGINAL) --- */
        :root {
            --bg-dark: #1a1a1d;      
            --bg-panel: #252529;     
            --safety-yellow: #facc15; 
            --tech-blue: #0ea5e9;    
            --text-light: #e5e7eb;
            --grid-color: rgba(255, 255, 255, 0.07);
        }

        body {
            font-family: 'Chakra Petch', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-light);
            background-image: 
                linear-gradient(var(--grid-color) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid-color) 1px, transparent 1px);
            background-size: 40px 40px;
            overflow-x: hidden;
        }

        .scan-bar {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10; 
            background: linear-gradient(to bottom, transparent 0%, rgba(255, 255, 255, 0.15) 0.05%, transparent 0.1%);
            background-size: 100% 200vh; 
            animation: scan-move 10s linear infinite; 
            pointer-events: none;
        }

        @keyframes scan-move {
            0% { transform: translateY(-100vh); }
            100% { transform: translateY(100vh); }
        }

        .font-data { font-family: 'Roboto Mono', monospace; }

        .caution-stripes {
            background: repeating-linear-gradient(45deg, #000, #000 10px, #facc15 10px, #facc15 20px);
        }

        .header-industrial {
            background-color: #111;
            border-bottom: 4px solid var(--safety-yellow);
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            z-index: 50; position: sticky; top: 0;
        }

        .main-content-area { position: relative; }

        .card-industrial {
            background: var(--bg-panel);
            border: 1px solid #444;
            position: relative; z-index: 30; 
            transition: all 0.3s ease;
            clip-path: polygon(0 0, 100% 0, 100% 85%, 90% 100%, 0 100%);
        }
        
        .card-industrial:hover {
            transform: translateY(-5px);
            border-color: var(--safety-yellow);
            box-shadow: 0 10px 30px rgba(250, 204, 21, 0.1);
        }
        
        .card-industrial::before {
            content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%;
            background: #444; transition: background 0.3s;
        }
        
        .card-industrial:hover::before { background: var(--safety-yellow); }

        input, select, textarea {
            background-color: #151515;
            border: 1px solid #555;
            color: white;
            font-family: 'Roboto Mono', monospace;
            border-left: 3px solid var(--tech-blue);
        }
        input:focus, select:focus {
            outline: none; border-color: var(--safety-yellow); background-color: #1a1a1a;
        }

        .btn-submit {
            background-color: var(--tech-blue);
            color: black;
            font-weight: 800; text-transform: uppercase; letter-spacing: 1px;
            border: none; border-bottom: 4px solid #0284c7;
        }
        .btn-submit:active {
            transform: translateY(2px); border-bottom: 0; margin-top: 4px;
        }

        .tech-table th {
            background-color: #333;
            color: var(--safety-yellow);
            font-weight: 700; text-transform: uppercase; letter-spacing: 1px;
            border-bottom: 2px solid var(--safety-yellow);
        }
        .tech-table td { border-bottom: 1px solid #333; padding: 12px; }

        .blink-red { animation: blink-anim 1s infinite; background-color: #ef4444; }
        .blink-green { animation: blink-anim 1.5s infinite; background-color: #22c55e; }
        .blink-text { animation: blink-text-anim 1s infinite; }
        
        @keyframes blink-anim {
            0% { opacity: 1; box-shadow: 0 0 5px currentColor; }
            50% { opacity: 0.4; box-shadow: none; }
            100% { opacity: 1; box-shadow: 0 0 5px currentColor; }
        }
        @keyframes blink-text-anim {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }

        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #555; border-radius: 0; }
        ::-webkit-scrollbar-thumb:hover { background: var(--safety-yellow); }

        .hidden { display: none !important; }
        
        .corner-bracket {
            position: absolute; width: 20px; height: 20px;
            border: 2px solid var(--safety-yellow); pointer-events: none;
        }
        .cb-tl { top: -2px; left: -2px; border-right: none; border-bottom: none; }
        .cb-br { bottom: -2px; right: -2px; border-left: none; border-top: none; }
        
        .industrial-footer { z-index: 50; position: relative; }

        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col relative">

    <div class="scan-bar"></div>

    <header class="header-industrial">
        <div class="h-2 w-full caution-stripes"></div>
        <div class="container mx-auto p-4 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-4 w-full md:w-auto border-l-4 border-blue-500 pl-4 bg-white/5 p-2">
                
                <img src="logosmk.png" onerror="this.src='https://via.placeholder.com/64?text=SMK'" alt="Logo SMK" class="w-16 h-16 object-contain drop-shadow-[0_0_5px_rgba(255,255,255,0.3)] hover:scale-105 transition-transform duration-300">
                
                <div>
                    <h1 class="text-3xl font-bold text-white tracking-tighter uppercase leading-none">SMKN 2 TERBANGGI BESAR</h1>
                    <div class="flex items-center gap-2 mt-1">
                        <span class="bg-blue-600 text-white text-[10px] font-bold px-1 py-0.5 rounded">PRODI</span>
                        <p class="text-sm text-yellow-400 font-bold tracking-wide">DESAIN PEMODELAN DAN INFORMASI BANGUNAN</p>
                    </div>
                </div>
            </div>

            <div class="w-full md:w-auto flex items-center justify-between md:justify-end gap-4 bg-black/40 p-2 rounded border border-gray-700">
                <div class="flex flex-col items-end mr-2">
                    <div class="flex items-center gap-2 mb-1">
                        <span class="text-xs font-bold text-gray-400 uppercase tracking-widest">firebase Status</span>
                        <div class="flex items-center gap-1 bg-black px-2 py-1 rounded border border-green-900">
                            <div class="w-3 h-3 rounded-full blink-green" id="status-indicator"></div>
                            <span class="text-green-500 font-bold text-xs" id="status-text">CONNECTED</span>
                        </div>
                    </div>
                </div>
                <div class="text-right border-l border-gray-600 pl-4">
                    <div id="realtime-clock" class="text-xl font-data font-bold text-white leading-none">00:00</div>
                    <div id="realtime-date" class="text-[10px] text-blue-400 font-bold mt-1 uppercase tracking-widest">...</div>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-grow container mx-auto p-6 md:p-10 main-content-area">
        
        <!-- DASHBOARD -->
        <section id="page-dashboard" class="fade-in">
            <div class="flex items-center gap-4 mb-8">
                <div class="h-8 w-2 bg-yellow-500"></div>
                <h2 class="text-2xl font-bold text-white uppercase tracking-widest">DPIB INVENTORY SYSTEM</h2>
                <div class="h-px bg-gray-700 flex-grow"></div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 max-w-6xl mx-auto">
                <button onclick="showPage('peminjaman')" class="card-industrial p-8 text-left group">
                    <div class="flex justify-between items-start mb-4">
                        <div class="bg-blue-900/30 p-4 rounded border border-blue-500/50 group-hover:bg-blue-600 transition-colors">
                            <i class="fa-solid fa-pen-ruler text-4xl text-blue-400 group-hover:text-white"></i>
                        </div>
                        <span class="text-4xl font-bold text-gray-700 group-hover:text-white/20 transition-colors">01</span>
                    </div>
                    <h3 class="text-xl font-bold text-white mb-2 group-hover:text-yellow-400">PEMINJAMAN ALAT</h3>
                    <p class="text-sm text-gray-400">Input data peminjaman baru.</p>
                    <div class="mt-4 w-8 h-1 bg-blue-500 group-hover:w-full transition-all duration-500"></div>
                </button>

                <button onclick="showPage('pengembalian')" class="card-industrial p-8 text-left group">
                    <div class="flex justify-between items-start mb-4">
                        <div class="bg-yellow-900/30 p-4 rounded border border-yellow-500/50 group-hover:bg-yellow-600 transition-colors">
                            <i class="fa-solid fa-clipboard-check text-4xl text-yellow-400 group-hover:text-white"></i>
                        </div>
                        <span class="text-4xl font-bold text-gray-700 group-hover:text-white/20 transition-colors">02</span>
                    </div>
                    <h3 class="text-xl font-bold text-white mb-2 group-hover:text-yellow-400">PENGEMBALIAN ALAT</h3>
                    <p class="text-sm text-gray-400">Monitoring dan checklist pengembalian.</p>
                    <div class="mt-4 w-8 h-1 bg-yellow-500 group-hover:w-full transition-all duration-500"></div>
                </button>

                <button onclick="showPage('pemakaian')" class="card-industrial p-8 text-left group">
                    <div class="flex justify-between items-start mb-4">
                        <div class="bg-gray-800 p-4 rounded border border-gray-500 group-hover:bg-gray-600 transition-colors">
                            <i class="fa-solid fa-file-csv text-4xl text-gray-400 group-hover:text-white"></i>
                        </div>
                        <span class="text-4xl font-bold text-gray-700 group-hover:text-white/20 transition-colors">03</span>
                    </div>
                    <h3 class="text-xl font-bold text-white mb-2 group-hover:text-yellow-400">REKAP DATA (ADMIN ONLY)</h3>
                    <p class="text-sm text-gray-400">01</p>
                    <div class="mt-4 w-8 h-1 bg-gray-500 group-hover:w-full transition-all duration-500"></div>
                </button>
            </div>
        </section>

        <!-- HALAMAN PEMINJAMAN -->
        <section id="page-peminjaman" class="hidden max-w-4xl mx-auto fade-in">
            <div class="flex justify-between items-center mb-6">
                <button onclick="showPage('dashboard')" class="flex items-center gap-2 text-gray-400 hover:text-white transition font-bold uppercase text-sm">
                    <i class="fa-solid fa-arrow-left bg-gray-800 p-2 rounded"></i> Kembali
                </button>
                <div class="text-right">
                    <h2 class="text-2xl font-bold text-blue-400 uppercase">Form Peminjaman Alat</h2>
                    <p class="text-xs text-gray-500">INPUT DATA PEMINJAM</p>
                </div>
            </div>

            <div class="bg-[#202024] p-8 shadow-2xl border-t-4 border-blue-500 relative">
                <div class="absolute top-2 left-2 text-gray-600"><i class="fa-solid fa-xmark"></i></div>
                <div class="absolute top-2 right-2 text-gray-600"><i class="fa-solid fa-xmark"></i></div>

                <form id="form-pinjam">
                    <div class="bg-black/30 p-4 mb-6 border border-gray-700 flex items-center gap-4">
                        <i class="fa-regular fa-calendar-days text-blue-500 text-xl"></i>
                        <div class="flex-grow">
                            <label class="text-[10px] text-gray-400 uppercase font-bold tracking-widest">Tanggal Peminjaman</label>
                            <input type="date" id="input-tanggal" required readonly class="w-full bg-transparent border-none text-xl font-bold text-white p-0 focus:ring-0 h-auto">
                        </div>
                    </div>

                    <!-- MODIFIKASI: Menambahkan Opsi 'Lainnya' pada Kelas dan Jurusan -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label class="block text-xs font-bold text-gray-400 mb-2 uppercase"><i class="fa-solid fa-layer-group mr-1 text-yellow-500"></i> KELAS </label>
                            <select id="input-kelas" onchange="updateDaftarSiswa()" required class="w-full p-3 text-sm">
                                <option value="">-- PILIH KELAS --</option>
                                <option value="X">KELAS X</option>
                                <option value="XI">KELAS XI</option>
                                <option value="XII">KELAS XII</option>
                                <option value="Lainnya">LAINNYA / GURU / STAF</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-400 mb-2 uppercase"><i class="fa-solid fa-bezier-curve mr-1 text-yellow-500"></i> JURUSAN </label>
                            <select id="input-jurusan" onchange="updateDaftarSiswa()" required class="w-full p-3 text-sm">
                                <option value="">-- PILIH JURUSAN --</option>
                                <option value="DPIB-1">DPIB 1</option>
                                <option value="DPIB-2">DPIB 2</option>
                                <option value="Lainnya">LAINNYA / UMUM</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-6 relative">
                        <label class="block text-xs font-bold text-gray-400 mb-2 uppercase"><i class="fa-solid fa-user-graduate mr-1 text-yellow-500"></i> Nama Peminjam</label>
                        
                        <!-- Select untuk Siswa DPIB -->
                        <select id="input-nama" disabled required class="w-full p-3 text-sm bg-gray-900 disabled:opacity-50">
                            <option value="">(PILIH KELAS & JURUSAN TERLEBIH DAHULU )</option>
                        </select>
                        
                        <!-- Input Manual untuk 'Lainnya' (Hidden Default) -->
                        <!-- Style border-left yellow untuk membedakan -->
                        <input type="text" id="input-nama-manual" placeholder="KETIK NAMA LENGKAP (GURU / STAFF / LUAR)..." class="hidden w-full p-3 text-sm bg-[#151515] text-white border-l-4 border-yellow-500 uppercase font-bold focus:border-yellow-400 outline-none">
                    </div>

                    <div class="h-px bg-gray-700 w-full mb-6 border-t border-dashed border-gray-600"></div>

                    <div class="grid grid-cols-1 md:grid-cols-12 gap-6 mb-8">
                        <div class="md:col-span-6">
                            <label class="block text-xs font-bold text-blue-400 mb-2 uppercase">Nama Alat / Barang</label>
                            <select id="input-alat" onchange="cekAlatLainnya(this)" required class="w-full p-3 font-bold text-white bg-blue-900/20 border-blue-500">
                                <option value="">-- PILIH ALAT --</option>
                                <option value="Penggaris Segitiga">Penggaris Segitiga</option>
                                <option value="Kalkulator Dexin">Kalkulator Dexin</option>
                                <option value="Kalkulator Kawachi">Kalkulator Kawachi</option>
                                <option value="Lainnya">Lainnya (Isi Manual)</option>
                            </select>
                            <input type="text" id="input-alat-lain" placeholder="Ketik nama alat spesifik..." class="hidden w-full mt-2 p-3 border-yellow-500 text-yellow-400">
                        </div>

                        <div class="md:col-span-3">
                            <label class="block text-xs font-bold text-gray-400 mb-2 uppercase">Jumlah</label>
                            <select id="input-jumlah" onchange="cekJumlahLainnya(this)" required class="w-full p-3 text-center">
                                <option value="">-- JUMLAH --</option>
                                <option value="1 Unit">1 Unit</option>
                                <option value="2 Unit">2 Unit</option>
                                <option value="3 Unit">3 Unit</option>
                                <option value="Lainnya">Lainnya</option>
                            </select>
                            <input type="number" id="input-jumlah-lain" min="1" placeholder="0" class="hidden w-full mt-2 p-3 text-center border-yellow-500 text-yellow-400 font-bold bg-[#151515] border border-l-[3px] border-l-yellow-500 outline-none">
                        </div>

                        <div class="md:col-span-3">
                            <label class="block text-xs font-bold text-gray-400 mb-2 uppercase">No. Alat / Kode</label>
                            <input type="text" id="input-kode" placeholder="-- TULIS NO. / KODE ALAT --" required class="w-full p-3 text-center font-bold uppercase text-yellow-500">
                        </div>
                    </div>

                    <button type="button" id="btn-save-firebase" class="btn-submit w-full py-4 rounded text-lg shadow-lg hover:bg-blue-400 transition flex justify-center items-center gap-2">
                        <i class="fa-solid fa-cloud-arrow-up"></i> SIMPAN DATA
                    </button>
                </form>
            </div>
        </section>

        <!-- HALAMAN PENGEMBALIAN (MONITORING) -->
        <section id="page-pengembalian" class="hidden max-w-6xl mx-auto fade-in">
            <div class="flex justify-between items-center mb-6">
                <button onclick="showPage('dashboard')" class="flex items-center gap-2 text-gray-400 hover:text-white transition font-bold uppercase text-sm">
                    <i class="fa-solid fa-arrow-left bg-gray-800 p-2 rounded"></i> KEMBALI
                </button>
                <h2 class="text-2xl font-bold text-yellow-500 uppercase">FORM PENGEMBALIAN ALAT</h2>
            </div>

            <div class="bg-[#202024] border border-gray-700 p-1 relative">
                <div class="corner-bracket cb-tl"></div>
                <div class="corner-bracket cb-br"></div>

                <div class="bg-black/50 p-2 flex flex-col md:flex-row justify-between items-center border-b border-gray-700 mb-4 gap-3">
                    <div class="flex items-center gap-4 w-full md:w-auto">
                         <span class="text-xs font-mono text-gray-400 ml-2 hidden md:inline">> FIRESTORE_STREAM: <span class="text-green-500 blink-text">LIVE</span></span>
                    </div>

                    <div class="flex items-center gap-2 w-full md:w-auto">
                        <div class="relative flex-grow md:flex-grow-0">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-2 text-gray-500">
                                <i class="fa-solid fa-search"></i>
                            </span>
                            <input type="text" id="cari-kode" placeholder="Cari Kode Alat..." 
                                class="w-full md:w-64 bg-gray-800 border border-gray-600 text-white text-xs py-2 pl-8 pr-2 rounded focus:border-yellow-500 outline-none uppercase font-mono">
                        </div>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm tech-table font-data">
                        <thead>
                            <tr>
                                <th class="w-10 text-center"><i class="fa-regular fa-square-check"></i></th>
                                <th>Tanggal</th>
                                <th>Nama Peminjam</th> <!-- Diubah labelnya agar umum -->
                                <th>Detail Alat</th>
                                <th class="text-center">Kode</th>
                                <th class="text-center">Status</th>
                            </tr>
                        </thead>
                        <tbody id="tabel-peminjaman" class="text-gray-300">
                            <!-- DATA DARI FIRESTORE AKAN MUNCUL DISINI -->
                        </tbody>
                    </table>
                </div>
                
                <div id="loading-indicator" class="text-center py-8 text-yellow-500">
                    <i class="fa-solid fa-circle-notch fa-spin text-3xl"></i>
                    <p class="text-xs mt-2 uppercase">Syncing with Cloud...</p>
                </div>
                
                <div id="error-message" class="text-center py-8 text-red-500 hidden">
                    <i class="fa-solid fa-triangle-exclamation text-3xl"></i>
                    <p class="text-xs mt-2 uppercase font-bold">KONEKSI DATABASE TERPUTUS / ERROR</p>
                    <p class="text-[10px] text-gray-500" id="error-text-detail">Cek Konsol Browser untuk detail.</p>
                </div>

                <div id="empty-state" class="text-center py-16 text-gray-600 hidden">
                    <i class="fa-solid fa-clipboard-check text-6xl mb-4 opacity-30"></i>
                    <p class="text-lg font-bold uppercase">Tidak ada peminjaman aktif</p>
                </div>

                <div class="mt-8 bg-gray-800 p-6 border-t-4 border-yellow-500">
                    <div class="flex items-center gap-2 mb-4">
                        <i class="fa-solid fa-shield-halved text-yellow-500"></i>
                        <h3 class="font-bold text-white uppercase">konfirmasi Pengembalian (Admin Only)</h3>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                        <div class="md:col-span-4">
                            <label class="text-[10px] font-bold text-gray-400 uppercase mb-1">Kondisi Barang Saat dikembalikan</label>
                            <select id="return-condition" class="w-full p-2 bg-black border border-gray-600 text-white">
                                <option value="OK">OK</option>
                                <option value="NG">NG (GANTI RUGI)</option>
                                <option value="HILANG">HILANG (GANTI RUGI)</option>
                            </select>
                        </div>
                        <div class="md:col-span-4">
                            <label class="text-[10px] font-bold text-gray-400 uppercase mb-1">MASUKAN PASSWORD</label>
                            <input type="password" id="admin-password" placeholder="INPUT PASSWORD" class="w-full p-2 bg-black border border-gray-600 text-center">
                        </div>
                        <div class="md:col-span-4">
                            <button id="btn-return-firebase" class="w-full bg-yellow-500 hover:bg-yellow-400 text-black font-bold py-2 px-4 uppercase shadow-lg border-b-4 border-yellow-700 active:border-0 active:mt-1 transition-all">
                                <i class="fa-solid fa-check mr-2"></i> Proses Pengembalian
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- HALAMAN REKAP (LOCKED BY ADMIN) -->
        <section id="page-pemakaian" class="hidden max-w-4xl mx-auto pt-10 text-center fade-in">
            <button onclick="showPage('dashboard')" class="mb-8 text-gray-400 hover:text-white font-bold uppercase text-sm">
                <i class="fa-solid fa-arrow-left mr-2"></i> Dashboard
            </button>
            <div class="caution-stripes h-4 w-full mb-0"></div>
            
            <div class="bg-gray-800 p-12 border border-gray-600 shadow-2xl relative">
                
                <!-- LOCK SCREEN OVERLAY -->
                <div id="admin-lock-screen" class="w-full">
                    <i class="fa-solid fa-lock text-6xl text-red-500 mb-6"></i>
                    <h2 class="text-3xl font-bold text-white mb-2 uppercase">RESTRICTED ACCESS</h2>
                    <p class="text-gray-400 mb-6">Area ini berisi data sensitif seluruh peminjaman siswa.<br>Silakan masukan kode otorisasi.</p>
                    
                    <div class="max-w-xs mx-auto flex gap-2">
                        <input type="password" id="download-auth-pass" placeholder="Password Admin..." class="w-full p-3 text-center bg-black border border-gray-500 text-white">
                        <button onclick="verifyAdminDownload()" class="bg-red-600 hover:bg-red-500 text-white px-4 font-bold border border-red-800">
                            <i class="fa-solid fa-key"></i>
                        </button>
                    </div>
                </div>

                <!-- DOWNLOAD AREA (HIDDEN INITIALLY) -->
                <div id="admin-download-area" class="hidden fade-in">
                    <div class="absolute top-4 right-4 text-green-500 text-xs font-mono border border-green-500 px-2 py-1">ACCESS GRANTED</div>
                    
                    <i class="fa-solid fa-file-csv text-7xl text-green-500 mb-6"></i>
                    <h2 class="text-3xl font-bold text-white mb-2 uppercase">DATABASE EXPORT</h2>
                    <p class="text-gray-400 mb-6">Data disimpan di Cloud Firestore. Anda dapat mengunduh seluruh riwayat (termasuk yang sudah dikembalikan) ke format Excel/CSV.</p>
                    
                    <button onclick="downloadLaporanCSV()" class="inline-block px-8 py-4 bg-green-700 hover:bg-green-600 text-white font-bold rounded shadow-lg transition-all border border-green-500">
                        <i class="fa-solid fa-download mr-2"></i> DOWNLOAD REKAP (.CSV)
                    </button>

                    <div class="mt-6 text-xs text-gray-500 font-mono">
                        *File .CSV dapat dibuka dengan Microsoft Excel atau Google Sheets.
                    </div>
                </div>

            </div>
            <div class="caution-stripes h-4 w-full mt-0"></div>
        </section>

    </main>

    <!-- MODAL -->
    <div id="custom-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center">
        <div class="bg-black/80 absolute inset-0 backdrop-blur-sm"></div>
        <div class="relative z-10 w-full max-w-md bg-[#222] border-2 border-white shadow-[0_0_30px_rgba(0,0,0,0.5)] transform scale-95 opacity-0 transition-all duration-300" id="modal-content">
            <div class="bg-white p-3 flex justify-between items-center" id="modal-header-bg">
                <h3 id="modal-title" class="text-black font-bold uppercase text-lg tracking-wider">NOTIFIKASI</h3>
                <i id="modal-icon" class="text-2xl text-black"></i>
            </div>
            <div class="p-6 text-center">
                <p id="modal-message" class="text-gray-300 text-sm mb-6 font-data leading-relaxed">Pesan...</p>
                <button onclick="closeModal()" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-8 w-full uppercase tracking-widest border border-gray-500">
                    TUTUP
                </button>
            </div>
            <div class="h-2 w-full caution-stripes"></div>
        </div>
    </div>

    <!-- FOOTER ORIGINAL RESTORED -->
    <footer class="bg-[#111] border-t-4 border-blue-600 mt-auto industrial-footer">
        
        <div class="bg-black border-b border-gray-800 font-data text-xs py-3 px-4 flex items-center gap-4 overflow-hidden shadow-inner relative z-20 h-10">
            <div class="flex items-center gap-3 shrink-0 text-gray-400 z-10 bg-black pr-2 border-r border-gray-800">
                <span>[NETWORK:<span class="text-green-500 font-bold">ONLINE</span>]</span>
                <span>[SRV:<span class="text-blue-500 font-bold">STANDBY</span>]</span>
            </div>
            
            <div class="flex-grow text-gray-400 overflow-hidden whitespace-nowrap flex items-center">
                <span class="text-yellow-500 mr-2">></span>
                <span id="terminal-text" class="text-gray-300 font-bold tracking-wide"></span>
                <span class="animate-pulse text-yellow-500 font-bold ml-1">_</span>
            </div>
        </div>

        <div class="container mx-auto py-6 px-4 flex justify-center items-center gap-4">
            
            <div class="flex flex-col items-center">
                <div class="flex items-center gap-2">
                    <div class="w-3 h-3 bg-yellow-500 animate-pulse border border-white"></div>
                    <p class="text-white font-bold text-lg tracking-wider">Â©DIPB SYSTEM <span class="text-blue-500">V.1-2025</span></p>
                </div>
                <p class="text-gray-500 text-xs font-bold uppercase mt-1">Design & development by: Arf Wicvk</p>
            </div>
        </div>
    </footer>

    <!-- MODULE FIREBASE -->
    <script type="module">
        // --- 1. IMPORT FIREBASE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, query, where, orderBy, getDocs } 
        from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // --- 2. KONFIGURASI (DATA DARI PROJECT ANDA) ---
        // PENTING: PASTIKAN DATA INI SUDAH BENAR
        const firebaseConfig = {
          apiKey: "AIzaSyDDHwbFq1rFoSImy3I8g3O820vV_sPdEHE",
          authDomain: "dpib-system-v2.firebaseapp.com",
          projectId: "dpib-system-v2",
          storageBucket: "dpib-system-v2.firebasestorage.app",
          messagingSenderId: "444034231596",
          appId: "1:444034231596:web:087a500225bffabe7d5089"
        };

        // --- 3. INISIALISASI ---
        let app, db;
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            console.log("Firebase Connected");
        } catch (error) {
            console.error("Firebase Error:", error);
            alert("Gagal koneksi ke database. Pastikan Config sudah benar.");
        }

        // --- GLOBAL VARIABLES (Agar bisa diakses fungsi biasa) ---
        window.db = db; 
        window.collection = collection;
        window.addDoc = addDoc;
        window.onSnapshot = onSnapshot;
        window.doc = doc;
        window.updateDoc = updateDoc;
        window.query = query;
        window.where = where;
        window.orderBy = orderBy;
        window.getDocs = getDocs;

        // --- DATABASE SISWA STATIC ---
        window.databaseSiswa = {
            "X-DPIB-1": ["Adam Ilham Darmawan",
  "Agnesya Alfiani",
  "Agung Satria Utama",
  "Agustina",
  "Ainul Mardiah",
  "Aldiano Afandy",
  "Ali Fahmi Setioso",
  "Amelia Bunga Safitri",
  "Andika Dwi Saputra",
  "Ari Nanda Fefrian",
  "Bayu Ahmad Nur Iman",
  "Chandra Wira Atmaja",
  "Daffa Sauqi",
  "Deby Orlando Pratama",
  "Dino Afria",
  "Dzaidan Akmal Pratama",
  "Eka Setyawan",
  "Elsya Alfiani",
  "Fadlan Nabil Rifqi Syafiq",
  "Fharel Hardinata M. Nur",
  "Handy Rydho Wijaya",
  "Ika Agustina",
  "Intan Nuraini",
  "Jana Suryana",
  "Kharisma Dinda Ramadhani",
  "M. Luthfi Maulana",
  "Muhammad Fadli",
  "Muhammad Haiqal",
  "Nesya Nandini",
  "Nuur Miftahul Jauhar",
  "Putri Adelina Ferani",
  "Putri Tansyier Dewi",
  "Rafa Drimaheza",
  "Rayhan Raynanda",
  "Rehan Adi Prasetio",
  "Riko Alfanando",
  "Shafira Nur Azizah",
  "Vika Herawati"
],
            "X-DPIB-2": [
  "Adonis Nandhito",
  "Agustian Fernando",
  "Aiko Alvizaudri Kenatra",
  "Akhmad Rizky Murtado",
  "Alfino Pramanta",
  "Alifah Kusuma Wardani",
  "Andhika Aziz Pratama",
  "Aretha Zhie Zhie S",
  "Aulia Febriyana",
  "Cahaya Putri Mariona",
  "Chila Viecho Nurhidayah",
  "Dava Danil Paresa",
  "Dika Saputra",
  "Diva Aprilia",
  "Eka Putra Wijaya",
  "Ellas Tirta Savana",
  "Faiz Al Qorni Hakim",
  "Gilang Setia An",
  "Hafizah Setia Ramadani",
  "Henky Triyan Syah",
  "Ilham Dinata",
  "Jaenal Sobirin",
  "Kayla Kania Alviona",
  "Luthfi Hanif",
  "Mela Novalia",
  "Muhammad Fahri",
  "Muhammad Rafly Al-Fahrezy",
  "Nino Oktaviano Saputra",
  "Oschar Parulian Tampubolon",
  "Putri Febriani",
  "Rahmad Ramadan",
  "Ramda Wirakka Pratama",
  "Refal Firmansyah",
  "Rika Saputri",
  "Selfi Mediari A. Zyahra",
  "Tholib Abdul Alim",
  "Zahra Amelia"
],
            "XI-DPIB-1": [
  "Abi Dwi Aryansyah",
  "Adrian July Saputra",
  "Agnes Fidela Asmara",
  "Ahmad Faqih Huntelaar",
  "Ainin Diniya Haqqi",
  "Alvin Andry Pratama",
  "Anggia Faulina",
  "Azzahra Kayla Nuranisa",
  "Bagus Tri Pujianto",
  "Celvin Niko Pratama",
  "Dani Firmansyah",
  "Dika Pratama",
  "Fajar Dzulkarnen",
  "Gevhandra Milando",
  "Hendra Kurniawan",
  "Intan Baro Maharani",
  "Keysia Putri Handayani",
  "Marcel Aditya",
  "Meliana Tista",
  "Muhamad Farel Raditya",
  "Muhammad Agil Saputra",
  "Muhammad Asfa Aldika",
  "Muhammad Haffiyan Zasin",
  "Ningrum Nur Annisa",
  "Raffi Galih Prasetyo",
  "Raka Reskiaditia Haltara",
  "Rio Zet Miko",
  "Syamsul Anwar Arafi"
],
            "XI-DPIB-2": [
  "Adzkia Purnomo",
  "Aisya Azzahra Sintia",
  "Andi Setiawan",
  "Arba Firmansyah",
  "Arda Jepriyan Syach",
  "Aziz Maulana Ishak",
  "Dikky Dwi Wibowo",
  "Fadli Azka Ramandika",
  "Fahriza Riswandi",
  "Farel Putra Ramadhan",
  "Inka Nabila",
  "Inna Raffa Firizku Subing",
  "Muhammad Iqbal Maulana",
  "Muhammad Nanda Arya Reza",
  "Muhammad Syahrul Munir",
  "Muhammad Taufiquzziyad",
  "Naifa Mezzaluna Ramadhani",
  "Noval Khoirul Efendi",
  "Pandu Adjie Dinata",
  "Refi Artikasari",
  "Riska Rahmawardani",
  "Rizky Aditya",
  "Rizky Pratama",
  "Siti Rahmawati",
  "Sultan Pasha Altafa",
  "Tirta Nur Khoirudin",
  "Veny Ferawati",
  "Yusuf Rama Winata",
  "Zhulfa Anisa Rayikinanti"
],
            "XII-DPIB-1": [
  "Agna Khoirul Nisa",
  "Agus Maulana Ikhsan",
  "All Shella Vierranitha Agliska",
  "Aprilia Dwi Lestari",
  "Az Zahra Annisa",
  "Cahaya Wulandari",
  "Citra Asti Mutia",
  "Claudia Dhiza Sheza Malika",
  "Daffa Khusnureza",
  "Damar Dwi Bimandika",
  "Dini Rahmadani",
  "Duwi Nofi Wulandari",
  "Egi Listianti",
  "Finka Indah Anggraini",
  "Herliza Awanda Octara",
  "Keysha Allifia Khairunisa",
  "Larasati Cahyaning Putri Hernadi",
  "M. Pasya Fauzi Sopian",
  "Muhamad Lutfi Pratama",
  "Muhammad Ihcan Ilham",
  "Muhammad Rizky",
  "Nadia Nurul Afifa",
  "Nawang Aufa Qurota Akyun",
  "Qurrota A'yun",
  "Rafi Debi Asmara",
  "Raditya Febrianza Rizantha",
  "Raihan Hakim",
  "Reno Andre Saputra",
  "Reza Nurul Safitri",
  "Safira",
  "Virgiawan Listianto",
  "Wanti Rahmadani",
  "Widya Fadilla Albadri"
],
            "XII-DPIB-2": [
  "Adika Ananta Ramli",
  "Adly Yovi Saputra",
  "Agam Prasetia Jaya",
  "Alif Dwi Kuncoro",
  "Alifia Aulia Amanda",
  "Andrea Dwi Ferliansyah",
  "Aria Agung Prasetio",
  "Bayhaqqi Rafli",
  "Bayu Catur Wijanarko",
  "Dimas Muhammad Afrizal",
  "Duwi Santika",
  "Ester Romauli Simatupang",
  "Fibri Lyiana",
  "Galang Satria Putra",
  "Galang Saputra",
  "Glend Andika Pratama",
  "Gusti Sona Zulyan Pratama",
  "Hayden Rio Saputra",
  "Iqbal Ferdiansyah",
  "Lucky Hermawan",
  "Maulana Abiyyu Faqih",
  "Muhamad Arif Aldo Maulana",
  "Muhammad Fani Praja Mandala",
  "Muhammad Raihan Wirayuda",
  "Muhammad Risky Syaputra",
  "Nabila",
  "Nasya Rahmawati",
  "Nesya Kurnia Sari",
  "Novita Sari",
  "Pirmansyah",
  "Ramadhan Erlang Khadafi",
  "Revan Sebastian Belandri",
  "Romli Affandi",
  "Siska Anggraini",
  "Yunita Agustina"
]
        };

        // --- LOGIC: SIMPAN (CREATE) ---
        const btnSave = document.getElementById('btn-save-firebase');
        if(btnSave) {
            btnSave.addEventListener('click', async (e) => {
                e.preventDefault();
                
                // MODIFIKASI: Mengambil nama dari Input Manual jika yang dipilih 'Lainnya', atau Dropdown jika Siswa DPIB
                let nama;
                const inputNamaManual = document.getElementById('input-nama-manual');
                const selectNama = document.getElementById('input-nama');

                // Logika Cek mana yang aktif (tidak hidden)
                if (!inputNamaManual.classList.contains('hidden')) {
                    nama = inputNamaManual.value; // Ambil dari input manual
                } else {
                    nama = selectNama.value; // Ambil dari dropdown
                }

                if (!nama) { showModal('GAGAL', 'Nama Peminjam wajib diisi.', 'error'); return; }

                const tanggal = document.getElementById('input-tanggal').value;
                const kelas = document.getElementById('input-kelas').value;
                const jurusan = document.getElementById('input-jurusan').value;
                
                let alat = document.getElementById('input-alat').value;
                if (alat === 'Lainnya') alat = document.getElementById('input-alat-lain').value;
                
                let jumlah = document.getElementById('input-jumlah').value;
                if (jumlah === 'Lainnya') {
                    const val = document.getElementById('input-jumlah-lain').value;
                    jumlah = val + " Unit";
                }
                
                const kode = document.getElementById('input-kode').value;

                // Animasi Loading
                btnSave.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> MENYIMPAN...';
                btnSave.disabled = true;

                try {
                    // SIMPAN KE FIRESTORE
                    await addDoc(collection(db, "peminjaman_dpib"), {
                        tanggal: tanggal,
                        kelas: kelas,
                        jurusan: jurusan,
                        nama: nama,
                        alat: alat,
                        jumlah: jumlah,
                        kode: kode,
                        status: 'DIPINJAM', // Status awal
                        kondisi_kembali: '-',
                        timestamp: new Date() // Untuk sorting
                    });

                    // Reset Form
                    document.getElementById('form-pinjam').reset();
                    document.getElementById('input-alat-lain').classList.add('hidden');
                    document.getElementById('input-jumlah-lain').classList.add('hidden');
                    
                    // Reset Logic Input Nama
                    document.getElementById('input-nama').disabled = true;
                    document.getElementById('input-nama').innerHTML = '<option value="">(Pilih Kelas & Jurusan)</option>';
                    document.getElementById('input-nama').classList.remove('hidden');
                    document.getElementById('input-nama-manual').classList.add('hidden');

                    document.getElementById('input-tanggal').value = new Date().toISOString().split('T')[0];

                    showModal('TERSIMPAN DI CLOUD', `Data a.n <b>${nama}</b> berhasil masuk database.`, 'success');
                } catch (error) {
                    console.error("Error adding document: ", error);
                    showModal('ERROR', 'Gagal menyimpan ke database.', 'error');
                } finally {
                    btnSave.innerHTML = '<i class="fa-solid fa-cloud-arrow-up"></i> SIMPAN DATA';
                    btnSave.disabled = false;
                }
            });
        }

        // --- LOGIC: BACA DATA (REALTIME LISTENER) - VERSI FIX CLIENT SORT ---
        function setupRealtimeListener() {
            // FIX: Hapus orderBy("timestamp", "desc") agar tidak perlu Index
            const q = query(
                collection(db, "peminjaman_dpib"), 
                where("status", "==", "DIPINJAM")
            );

            // FIX: Tambah Error Handler di argumen kedua onSnapshot
            const unsubscribe = onSnapshot(q, (snapshot) => {
                const tbody = document.getElementById('tabel-peminjaman');
                const loading = document.getElementById('loading-indicator');
                const empty = document.getElementById('empty-state');
                const searchInput = document.getElementById('cari-kode');
                const errorMsg = document.getElementById('error-message');
                const keyword = searchInput.value.toLowerCase();

                // Reset Tampilan
                tbody.innerHTML = '';
                loading.classList.add('hidden');
                errorMsg.classList.add('hidden');

                const items = [];
                snapshot.forEach((doc) => {
                    items.push({ id: doc.id, ...doc.data() });
                });

                // LOGIC SORTING CLIENT SIDE (Javascript)
                // Mengurutkan berdasarkan timestamp (Terbaru di atas)
                items.sort((a, b) => {
                    const timeA = a.timestamp && a.timestamp.seconds ? a.timestamp.seconds : 0;
                    const timeB = b.timestamp && b.timestamp.seconds ? b.timestamp.seconds : 0;
                    return timeB - timeA; // Descending
                });

                const filteredItems = items.filter(item => item.kode.toLowerCase().includes(keyword));

                if (filteredItems.length === 0) {
                    empty.classList.remove('hidden');
                } else {
                    empty.classList.add('hidden');
                    filteredItems.forEach(item => {
                        
                        // MODIFIKASI: Logika Tampilan untuk Peminjam "Lainnya"
                        let displayKelasJurusan = `<div class="text-xs text-blue-400 font-bold">${item.kelas} ${item.jurusan}</div>`;
                        
                        if(item.kelas === 'Lainnya' || item.jurusan === 'Lainnya') {
                            displayKelasJurusan = `<div class="text-[10px] text-red-500 font-bold border border-red-900 bg-red-900/20 inline-block px-1 rounded mt-1">LAINNYA / EKSTERNAL</div>`;
                        }

                        const row = `
                            <tr class="hover:bg-gray-800 transition">
                                <td class="text-center align-middle">
                                    <input type="checkbox" class="w-5 h-5 checkbox-kembali accent-yellow-500 cursor-pointer" value="${item.id}">
                                </td>
                                <td class="font-data text-sm text-gray-400">${item.tanggal}</td>
                                <td>
                                    <div class="font-bold text-white text-base">${item.nama}</div>
                                    ${displayKelasJurusan}
                                </td>
                                <td class="text-gray-300 text-sm">
                                    <span class="text-yellow-500 font-bold">${item.alat}</span>
                                    <br><span class="text-xs text-gray-500">Jml: ${item.jumlah}</span>
                                </td>
                                <td class="text-center font-data font-bold text-white bg-gray-800 p-1 border border-gray-600 rounded">
                                    <span class="${keyword && item.kode.toLowerCase().includes(keyword) ? 'bg-yellow-500 text-black px-1' : ''}">${item.kode}</span>
                                </td>
                                <td class="text-center"><span class="bg-red-600 text-white text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wider shadow-red-glow">DIPINJAM</span></td>
                            </tr>
                        `;
                        tbody.innerHTML += row;
                    });
                }
            }, (error) => {
                // ERROR HANDLER JIKA TERJADI MASALAH (Misal Koneksi/Permission)
                console.error("Firestore Listener Error:", error);
                document.getElementById('loading-indicator').classList.add('hidden');
                document.getElementById('error-message').classList.remove('hidden');
                document.getElementById('error-text-detail').innerText = error.message || "Unknown error occurred.";
            });
        }
        setupRealtimeListener();

        // --- LOGIC: PENGEMBALIAN (UPDATE) ---
        const btnReturn = document.getElementById('btn-return-firebase');
        if(btnReturn) {
            btnReturn.addEventListener('click', async () => {
                const passwordInput = document.getElementById('admin-password').value;
                // GANTI DENGAN PASSWORD ADMIN YG SESUAI
                if (passwordInput !== "lab15.30") { 
                    showModal('AKSES DITOLAK', 'Password Admin Salah!', 'error');
                    return;
                }

                const checkboxes = document.querySelectorAll('.checkbox-kembali:checked');
                if (checkboxes.length === 0) {
                    showModal('PERHATIAN', 'Pilih data yang akan dikembalikan.', 'info');
                    return;
                }

                const kondisi = document.getElementById('return-condition').value;

                try {
                    const promises = [];
                    checkboxes.forEach(box => {
                        const docId = box.value;
                        const docRef = doc(db, "peminjaman_dpib", docId);
                        promises.push(updateDoc(docRef, {
                            status: "DIKEMBALIKAN",
                            kondisi_kembali: kondisi,
                            tanggal_kembali: new Date().toISOString().split('T')[0]
                        }));
                    });

                    await Promise.all(promises);

                    document.getElementById('admin-password').value = '';
                    showModal('SUKSES', `Data berhasil diupdate menjadi DIKEMBALIKAN.<br>Kondisi: <b>${kondisi}</b>`, 'success');
                } catch (error) {
                    console.error("Error updating: ", error);
                    showModal('ERROR', 'Gagal mengupdate data.', 'error');
                }
            });
        }
        
        // Search Fix untuk Realtime
        const searchInput = document.getElementById('cari-kode');
        searchInput.addEventListener('input', () => {
            // Karena data filtering sudah di dalam onSnapshot, cukup pastikan onSnapshot berhasil.
        });

    </script>

    <!-- LOGIC UI/UX STANDAR (Non-Firebase) -->
    <script>
        // --- TYPEWRITER LOG VARIABLES (DIKEMBALIKAN) ---
        const logMessages = [
            "SYSTEM_INIT: INITIALIZING CORE MODULES...",
            "CHECK_NET: CONNECTION ESTABLISHED (SECURE 100%)...",
            "DB_SYNC: VERIFYING INTEGRITY...",
            "LOADING_ASSETS: UI_INDUSTRIAL_V3 LOADED...",
            "ENCRYPTING_DATA_STREAM: [***********] 100%",
            "SECURITY_SCAN: NO THREATS DETECTED...",
            "WAITING_USER_INPUT: SYSTEM READY..."
        ];
        let logIndex = 0;
        let charIndex = 0;
        let isDeleting = false;
        const typeSpeed = 40; 
        const deleteSpeed = 20; 
        const delayNext = 2000;

        // --- CLOCK & UI UTILS ---
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('input-tanggal').value = today;
            setInterval(updateClock, 1000);
            updateClock();
            typeWriter(); // Jalankan animasi log
            
            // Tambahkan listener untuk input pencarian agar bekerja saat ada perubahan
            const searchInput = document.getElementById('cari-kode');
            searchInput.addEventListener('input', () => {
                const tbody = document.getElementById('tabel-peminjaman');
                const rows = tbody.querySelectorAll('tr');
                const keyword = searchInput.value.toLowerCase();
                
                rows.forEach(row => {
                    const kodeCell = row.querySelector('td:nth-child(5) span'); // Asumsi kode ada di kolom ke-5
                    if (kodeCell) {
                        const kode = kodeCell.textContent.toLowerCase();
                        if (kode.includes(keyword)) {
                            row.style.display = "";
                            kodeCell.innerHTML = kode.replace(new RegExp(keyword, 'gi'), match => `<span class="bg-yellow-500 text-black px-1">${match}</span>`);
                        } else {
                            row.style.display = "none";
                        }
                    }
                });
            });

        });

        // --- TYPEWRITER FUNCTION (DIKEMBALIKAN) ---
        function typeWriter() {
            const currentText = logMessages[logIndex];
            const logElement = document.getElementById('terminal-text');
            
            if (!logElement) return;

            if (isDeleting) {
                logElement.innerText = currentText.substring(0, charIndex - 1);
                charIndex--;
            } else {
                logElement.innerText = currentText.substring(0, charIndex + 1);
                charIndex++;
            }

            let nextSpeed = typeSpeed;

            if (!isDeleting && charIndex === currentText.length) {
                nextSpeed = delayNext;
                isDeleting = true;
            } else if (isDeleting && charIndex === 0) {
                isDeleting = false;
                logIndex = (logIndex + 1) % logMessages.length;
                nextSpeed = 500;
            } else if (isDeleting) {
                nextSpeed = deleteSpeed;
            }

            setTimeout(typeWriter, nextSpeed);
        }

        function updateClock() {
            const now = new Date();
            document.getElementById('realtime-clock').innerText = now.toLocaleTimeString('id-ID', {hour12: false});
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('realtime-date').innerText = now.toLocaleDateString('id-ID', options).toUpperCase();
        }

        function showPage(pageId) {
            document.getElementById('page-dashboard').classList.add('hidden');
            document.getElementById('page-peminjaman').classList.add('hidden');
            document.getElementById('page-pengembalian').classList.add('hidden');
            document.getElementById('page-pemakaian').classList.add('hidden');
            
            const target = document.getElementById('page-' + pageId);
            target.classList.remove('hidden');
            target.classList.add('fade-in');

            // Reset tampilan login download jika pindah halaman
            if(pageId !== 'pemakaian') {
                document.getElementById('admin-lock-screen').classList.remove('hidden');
                document.getElementById('admin-download-area').classList.add('hidden');
                document.getElementById('download-auth-pass').value = '';
            }

            // Hapus filter pencarian saat pindah ke monitoring
            if (pageId === 'pengembalian') {
                document.getElementById('cari-kode').value = '';
                // Ini akan memicu fungsi di atas untuk menampilkan semua data (jika listener sudah berjalan)
            }
        }

        // --- ADMIN CHECK FOR DOWNLOAD (BARU) ---
        function verifyAdminDownload() {
            const pass = document.getElementById('download-auth-pass').value;
            // GANTI DENGAN PASSWORD ADMIN YG SESUAI
            if(pass === 'lab15.30') {
                document.getElementById('admin-lock-screen').classList.add('hidden');
                document.getElementById('admin-download-area').classList.remove('hidden');
                document.getElementById('admin-download-area').classList.add('fade-in');
            } else {
                showModal('AKSES DITOLAK', 'Password Admin Salah!', 'error');
            }
        }

        // --- HELPER FORMS ---
        
        // MODIFIKASI: FUNGSI UPDATE DAFTAR SISWA SEKARANG MENANGANI OPSI 'LAINNYA'
        function updateDaftarSiswa() {
            const kelas = document.getElementById('input-kelas').value;
            const jurusan = document.getElementById('input-jurusan').value;
            
            const selectNama = document.getElementById('input-nama');
            const inputNamaManual = document.getElementById('input-nama-manual');

            // Logika Deteksi 'Lainnya'
            // Jika Salah satu (Kelas ATAU Jurusan) adalah 'Lainnya', aktifkan mode manual
            if (kelas === 'Lainnya' || jurusan === 'Lainnya') {
                // Sembunyikan Dropdown, Tampilkan Input Manual
                selectNama.classList.add('hidden');
                selectNama.required = false; // Disable required di select

                inputNamaManual.classList.remove('hidden');
                inputNamaManual.required = true; // Enable required di manual
                inputNamaManual.focus();
                
                return; // Berhenti disini, tidak perlu load databaseSiswa
            } 
            
            // Jika Normal (Siswa DPIB)
            selectNama.classList.remove('hidden');
            selectNama.required = true;
            
            inputNamaManual.classList.add('hidden');
            inputNamaManual.required = false;

            // Reset dan Load Data
            selectNama.innerHTML = '<option value="">-- PILIH NAMA --</option>';
            selectNama.disabled = true;

            if (kelas && jurusan) {
                const key = `${kelas}-${jurusan}`;
                const siswaList = window.databaseSiswa[key]; 
                if (siswaList) {
                    selectNama.disabled = false;
                    siswaList.forEach(nama => {
                        const option = document.createElement('option');
                        option.value = nama; option.text = nama;
                        selectNama.appendChild(option);
                    });
                }
            }
        }

        function cekAlatLainnya(selectObject) {
            const inputLain = document.getElementById('input-alat-lain');
            if (selectObject.value === 'Lainnya') {
                inputLain.classList.remove('hidden'); inputLain.required = true;
            } else {
                inputLain.classList.add('hidden'); inputLain.required = false;
            }
        }
        
        function cekJumlahLainnya(selectObject) {
            const inputLain = document.getElementById('input-jumlah-lain');
            if (selectObject.value === 'Lainnya') {
                inputLain.classList.remove('hidden'); inputLain.required = true; inputLain.focus();
            } else {
                inputLain.classList.add('hidden'); inputLain.required = false;
            }
        }

        // --- MODAL UTILS ---
        function showModal(title, message, type) {
            const modal = document.getElementById('custom-modal');
            const content = document.getElementById('modal-content');
            const headerBg = document.getElementById('modal-header-bg');
            const icon = document.getElementById('modal-icon');
            const titleEl = document.getElementById('modal-title');
            
            modal.classList.remove('hidden');
            setTimeout(() => {
                content.classList.remove('scale-95', 'opacity-0');
                content.classList.add('scale-100', 'opacity-100');
            }, 10);

            titleEl.innerText = title;
            document.getElementById('modal-message').innerHTML = message.replace(/\n/g, '<br>');

            if (type === 'success') {
                headerBg.className = "bg-green-600 p-4 flex justify-between items-center";
                titleEl.className = "text-white font-bold uppercase text-lg";
                icon.className = "fa-solid fa-check-circle text-white text-2xl";
            } else if (type === 'error') {
                headerBg.className = "bg-red-600 p-4 flex justify-between items-center";
                titleEl.className = "text-white font-bold uppercase text-lg";
                icon.className = "fa-solid fa-triangle-exclamation text-white text-2xl";
            } else {
                headerBg.className = "bg-white p-4 flex justify-between items-center";
                titleEl.className = "text-black font-bold uppercase text-lg";
                icon.className = "fa-solid fa-info-circle text-black text-2xl";
            }
        }

        function closeModal() {
            const modal = document.getElementById('custom-modal');
            const content = document.getElementById('modal-content');
            content.classList.remove('scale-100', 'opacity-100');
            content.classList.add('scale-95', 'opacity-0');
            setTimeout(() => { modal.classList.add('hidden'); }, 200);
        }

        // --- FUNGSI DOWNLOAD CSV (REKAP) ---
        async function downloadLaporanCSV() {
            if(!window.db) { showModal('ERROR', 'Database belum terkoneksi.', 'error'); return; }
            
            showModal('PLEASE WAIT', 'Sedang mengunduh data dari Cloud...', 'info');
            
            try {
                // Ambil SEMUA data
                // NOTE: Menggunakan orderBy di sini aman, karena kita tidak menggunakan filter where()
                const q = window.query(window.collection(window.db, "peminjaman_dpib"), window.orderBy("timestamp", "desc"));
                const querySnapshot = await window.getDocs(q);
                
                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += "Tanggal Pinjam,Nama Siswa,Kelas,Jurusan,Nama Alat,Jumlah,Kode,Status,Kondisi Kembali,Tanggal Kembali\n"; 

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const clean = (text) => text ? text.toString().replace(/,/g, " ") : "-";
                    
                    const row = [
                        clean(data.tanggal),
                        clean(data.nama),
                        clean(data.kelas),
                        clean(data.jurusan),
                        clean(data.alat),
                        clean(data.jumlah),
                        clean(data.kode),
                        clean(data.status),
                        clean(data.kondisi_kembali),
                        clean(data.tanggal_kembali)
                    ].join(",");
                    csvContent += row + "\r\n";
                });

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "REKAP_PEMINJAMAN_DPIB_" + new Date().toISOString().split('T')[0] + ".csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                closeModal(); 
                
            } catch (error) {
                console.error("Download error:", error);
                showModal('GAGAL', 'Gagal mengunduh data.', 'error');
            }
        }
    </script>
</body>
</html>

